# 中继点名活动管理系统说明文档

## 1. 系统架构

### 1.1 技术栈

**前端**
- React 19
- Ant Design 6
- React Router 6
- Zustand (状态管理)
- Axios (HTTP客户端)
- Vite (构建工具)

**后端**
- Node.js + Express
- Sequelize ORM
- SQLite数据库
- JWT (身份验证)
- bcrypt (密码加密)

### 1.2 项目结构

```
├── backend/              # 后端代码
│   ├── config/          # 配置文件
│   ├── middleware/      # 中间件
│   ├── models/          # 数据模型
│   ├── routes/          # 路由
│   ├── uploads/         # 上传文件目录
│   ├── app.js           # 主应用文件
│   └── package.json     # 依赖配置
├── frontend/            # 前端代码
│   ├── public/          # 静态资源
│   ├── src/             # 源代码
│   │   ├── components/  # 组件
│   │   ├── pages/       # 页面
│   │   ├── store/       # 状态管理
│   │   ├── utils/       # 工具函数
│   │   ├── App.jsx      # 应用入口
│   │   └── main.jsx     # 渲染入口
│   └── package.json     # 依赖配置
└── .env                 # 环境变量配置
```

### 1.3 数据库设计

#### 1.3.1 实体关系图

```
User ──┬─┐
       │ │
       │ └── SessionOperator ──┐
       │                       │
       │                       ▼
       │                 NetSession ──┬── Control
       │                              │
       │                              └── Log
       │
       └──────────────────────────────────┘

QthEntry (独立实体，用于QTH地址管理)
```

## 2. 数据模型

### 2.1 User (用户)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|----------|------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | 用户ID |
| username | STRING | UNIQUE, NOT NULL | 用户名 |
| password_hash | STRING | NOT NULL | 加密后的密码 |
| callsign | STRING | - | 操作员呼号 |
| role | ENUM | DEFAULT: operator | 角色(super_admin, admin, operator) |
| createdAt | DATE | - | 创建时间 |
| updatedAt | DATE | - | 更新时间 |

### 2.2 NetSession (活动)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|----------|------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | 活动ID |
| external_id | STRING | UNIQUE, NOT NULL | 活动外部ID |
| title | STRING | NOT NULL | 活动标题 |
| date | DATE | NOT NULL | 活动日期 |
| net_callsign | STRING | NOT NULL | 活动呼号 |
| tx_freq | STRING | NOT NULL | 发射频率 |
| rx_freq | STRING | - | 接收频率 |
| mode | STRING | NOT NULL | 通信模式 |
| band | STRING | NOT NULL | 波段 |
| created_by | INTEGER | FOREIGN KEY(User.id), NOT NULL | 创建者ID |
| createdAt | DATE | - | 创建时间 |
| updatedAt | DATE | - | 更新时间 |

### 2.3 Control (主控信息)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|----------|------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | 主控ID |
| session_id | INTEGER | FOREIGN KEY(NetSession.id), NOT NULL | 活动ID |
| callsign | STRING | NOT NULL | 呼号 |
| radio | STRING | - | 设备 |
| antenna | STRING | - | 天线 |
| power | STRING | - | 功率 |
| qth_text | STRING | - | 地理位置文本 |
| qth_province | STRING | - | 省份 |
| qth_city | STRING | - | 城市 |
| qth_district | STRING | - | 区县 |
| operator_user_id | INTEGER | FOREIGN KEY(User.id), NOT NULL | 操作员ID |
| createdAt | DATE | - | 创建时间 |
| updatedAt | DATE | - | 更新时间 |

### 2.4 Log (参与者记录)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|----------|------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | 记录ID |
| session_id | INTEGER | FOREIGN KEY(NetSession.id), NOT NULL | 活动ID |
| operator_user_id | INTEGER | FOREIGN KEY(User.id), NOT NULL | 操作员ID |
| participant_callsign | STRING | NOT NULL | 参与者呼号 |
| rst_rcvd | STRING | NOT NULL | 接收信号报告 |
| rst_sent | STRING | NOT NULL | 发送信号报告 |
| radio | STRING | - | 设备 |
| antenna | STRING | - | 天线 |
| power | STRING | - | 功率 |
| qth_text | STRING | - | 地理位置文本 |
| qth_province | STRING | - | 省份 |
| qth_city | STRING | - | 城市 |
| qth_district | STRING | - | 区县 |
| timestamp | DATE | DEFAULT: NOW, NOT NULL | 录入时间 |
| createdAt | DATE | - | 创建时间 |
| updatedAt | DATE | - | 更新时间 |

### 2.5 QthEntry (QTH地址)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|----------|------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | 地址ID |
| text | STRING | NOT NULL | 地理位置文本 |
| province | STRING | NOT NULL | 省份 |
| city | STRING | NOT NULL | 城市 |
| district | STRING | - | 区县 |
| createdAt | DATE | - | 创建时间 |
| updatedAt | DATE | - | 更新时间 |

### 2.6 SessionOperator (活动操作员关联)

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|----------|------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | 关联ID |
| session_id | INTEGER | FOREIGN KEY(NetSession.id), NOT NULL | 活动ID |
| user_id | INTEGER | FOREIGN KEY(User.id), NOT NULL | 用户ID |
| callsign | STRING | NOT NULL | 操作员呼号 |
| createdAt | DATE | - | 创建时间 |
| updatedAt | DATE | - | 更新时间 |

## 3. API接口

### 3.1 认证相关

| 接口 | 方法 | 路径 | 描述 |
|------|------|------|------|
| 用户注册 | POST | /api/register | 用户注册 |
| 用户登录 | POST | /api/login | 用户登录 |
| 获取当前用户 | GET | /api/me | 获取当前登录用户信息 |

### 3.2 用户管理

| 接口 | 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|------|
| 获取用户列表 | GET | /api/users | 获取所有用户 | super_admin |
| 创建用户 | POST | /api/users | 创建新用户 | super_admin |
| 更新用户 | PUT | /api/users/:id | 更新用户信息 | super_admin |
| 删除用户 | DELETE | /api/users/:id | 删除用户 | super_admin |

### 3.3 活动管理

| 接口 | 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|------|
| 获取活动列表 | GET | /api/sessions | 获取所有活动 | 所有用户 |
| 创建活动 | POST | /api/sessions | 创建新活动 | auth |
| 获取活动详情 | GET | /api/sessions/:id | 获取活动详情 | 所有用户 |
| 更新活动 | PUT | /api/sessions/:id | 更新活动信息 | auth |
| 删除活动 | DELETE | /api/sessions/:id | 删除活动 | admin或super_admin |
| 导出活动列表 | GET | /api/sessions/export/excel | 导出活动列表为Excel | 所有用户 |

### 3.4 参与者记录

| 接口 | 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|------|
| 创建参与者记录 | POST | /api/sessions/:session_id/logs | 创建参与者记录 | auth |
| 更新参与者记录 | PUT | /api/sessions/:session_id/logs/:log_id | 更新参与者记录 | auth |
| 删除参与者记录 | DELETE | /api/sessions/:session_id/logs/:log_id | 删除参与者记录 | auth |
| 获取最后记录 | GET | /api/last_by_callsign/:callsign | 根据呼号获取最后记录 | auth |

### 3.5 导入导出

| 接口 | 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|------|
| 导出活动为Excel | GET | /api/sessions/:id/export/excel | 导出活动记录为Excel | 所有用户 |
| 导出活动为ADIF | GET | /api/sessions/:id/export/adif | 导出活动记录为ADIF | 所有用户 |
| 导出所有活动 | GET | /api/all_sessions/export/excel | 导出所有活动记录 | 所有用户 |
| 下载导入模板 | GET | /api/import_template | 下载导入模板 | 所有用户 |
| 批量导入记录 | POST | /api/import_logs | 批量导入历史记录 | auth |
| 导出QTH数据 | GET | /api/qth/export | 导出QTH数据模板 | 所有用户 |
| 导入QTH数据 | POST | /api/qth/import | 导入QTH数据 | auth |

### 3.6 QTH地址管理

| 接口 | 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|------|
| QTH搜索 | GET | /api/qth/search | QTH地址模糊搜索 | auth |

## 4. 功能模块详细说明

### 4.1 活动管理模块

**活动创建/编辑表单**
- 活动标题：必填，字符串
- 外部ID：必填，字符串，唯一
- 活动日期：必填，日期时间
- 呼号：必填，字符串
- 发射频率：必填，字符串
- 接收频率：可选，字符串
- 模式：必填，枚举值(SSB, CW, FM, AM)
- 波段：必填，枚举值(160m, 80m, 40m, 20m, 15m, 10m, 6m, 2m, 70cm)
- 操作员：必填，多选，从用户列表中选择

**活动列表**
- 显示字段：活动标题、外部ID、活动日期、呼号、频率、模式、波段、操作员呼号
- 操作按钮：查看、开始活动、编辑、删除
- 下载活动列表功能

### 4.2 参与者记录模块

**记录录入表单**
- 参与者呼号：必填，字符串
- 接收信号报告：必填，字符串，默认59
- 发送信号报告：必填，字符串，默认59
- 设备：可选，字符串，自动填充
- 天线：可选，字符串，自动填充
- 功率：可选，字符串，自动填充
- QTH：可选，字符串，支持关键字搜索

**历史记录智能填充**
- 根据呼号自动填充设备、天线、功率等信息
- 从最近的记录中获取数据

**快捷键支持**
- F1：快速完成录入

### 4.3 数据导出模块

**Excel导出格式**
- 活动列表：包含活动基本信息
- 活动记录：包含活动信息和参与者详情
- 所有活动记录：包含所有活动的完整记录

**ADIF导出格式**
- 符合ADIF 3.1.4标准
- 包含必要的字段：CALL, RST_RCVD, RST_SENT, RIG, ANTENNA, PWR, QTH, QSO_DATE, TIME_ON, BAND, MODE, FREQ, STATION_CALLSIGN, OPERATOR
- 不包含自定义字段，避免影响其他系统导入

### 4.4 用户管理模块

**用户角色**
- super_admin：超级管理员，拥有所有权限
- admin：管理员，可管理活动和记录
- operator：操作员，只能录入记录

**用户属性**
- 每个用户必须有唯一的用户名
- 每个用户可以有唯一的呼号
- 密码使用bcrypt加密存储

### 4.5 QTH地址管理模块

**QTH数据结构**
- 支持结构化地址：省份、城市、区县
- 支持完整地理位置文本

**QTH搜索功能**
- 支持根据关键字搜索
- 搜索范围：地理位置文本、省份、城市、区县
- 返回前10条匹配结果

## 5. 开发规范和注意事项

### 5.1 代码风格

**JavaScript/TypeScript**
- 使用ES6+语法
- 采用函数式编程风格
- 使用箭头函数代替function关键字
- 使用const和let，避免var

**React**
- 使用函数组件和Hooks
- 组件命名使用PascalCase
- 文件名与组件名保持一致
- 使用useState、useEffect等Hooks管理状态和副作用

**数据库**
- 使用Sequelize ORM进行数据库操作
- 模型命名使用PascalCase
- 表名使用snake_case
- 外键命名使用_related_id格式

### 5.2 安全注意事项

- 所有敏感数据使用HTTPS传输
- 密码使用bcrypt加密存储
- 使用JWT进行身份验证，设置合理的过期时间
- 所有API接口添加身份验证中间件
- 防止SQL注入，使用参数化查询
- 防止XSS攻击，对输入进行过滤
- 防止CSRF攻击，使用JWT或CSRF令牌

### 5.3 性能优化

- 使用React.memo优化组件渲染
- 使用useCallback和useMemo优化函数和计算值
- 批量处理API请求
- 合理使用缓存
- 优化数据库查询，添加适当的索引
- 分页处理大量数据

## 6. 部署和运行说明

### 6.1 环境要求

- Node.js 18+ 
- npm 9+ 或 yarn 1.22+

### 6.2 安装和运行步骤

**后端**
```bash
# 进入后端目录
cd backend

# 安装依赖
npm install

# 启动服务器
npm start
```

**前端**
```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install

# 启动开发服务器
npm run dev
```

### 6.3 配置说明

**环境变量**
- PORT：服务器端口，默认3000
- JWT_SECRET：JWT密钥
- DB_PATH：SQLite数据库路径

**Vite代理配置**
```javascript
// vite.config.js
export default defineConfig({
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:3000',
        changeOrigin: true
      }
    }
  }
})
```

## 7. 二次开发建议

### 7.1 扩展点

- 支持更多数据导出格式
- 添加活动统计功能
- 支持活动图片上传
- 添加通知功能
- 支持多语言
- 添加数据备份和恢复功能

### 7.2 可能的优化方向

- 使用TypeScript增强类型安全
- 添加单元测试和集成测试
- 优化数据库查询性能
- 添加日志系统
- 实现CI/CD流程
- 优化前端加载性能

### 7.3 注意事项

- 保持数据模型的向后兼容性
- 遵循RESTful API设计原则
- 确保代码的可测试性和可维护性
- 定期更新依赖，修复安全漏洞
- 保持文档与代码同步

## 8. 版本信息

- 当前版本：v1.0
- 最后更新：2025-12-02
- 开发状态：基本功能已完成，可进行二次开发

## 9. 联系方式

如有任何问题或建议，请联系系统管理员。
